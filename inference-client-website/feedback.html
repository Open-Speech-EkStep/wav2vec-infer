<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedbacks</title>
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script type="text/javascript"
        src="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-html5-1.6.1/cr-1.5.2/datatables.min.js"></script>
</head>
<style>
    .result {
        margin-top: 20px;
    }

    .loader {
        margin-top: 20px;
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 30px;
        height: 30px;
        -webkit-animation: spin 2s linear infinite;
        /* Safari */
        animation: spin 2s linear infinite;
    }

    /* Safari */
    @-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
        }
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<body>
    <br />
    <br />

    <center>
        <h4>Inference Website Feedback</h4>
    </center>
    <br />
    <center>
        <div class="post-control-panel">
            <input type="text" placeholder="Search device" id="device-search" />
            &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
            <label for="rating-dropdown">Choose Rating</label>
            <select id="rating-dropdown">
                <option value="">No Filter</option>
                <option value="thumbs_up">Thumbs Up</option>
                <option value="thumbs_down">Thumbs Down</option>
            </select>
        </div>
    </center>
    <br />
    <table id="feedback-table" class="table table-striped table-bordered" width="98%" style="margin:20px !important;">
        <thead>
            <tr>
                <th>Audio</th>
                <th>Text</th>
                <th>Rating</th>
                <th>Device</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
    <script>
        $(document).ready(function () {
            let table = $('#feedback-table').DataTable({
                info: false,
                lengthChange: false,
                processing: true,
                searching: false,
                ordering: false,
                serverSide: true,
                ajax: {
                    "url": "api/feedback",
                    "data": function (d) {
                        return $.extend({}, d, {
                            "device_filter": $("#device-search").val().toLowerCase(),
                            "rating_filter": $("#rating-dropdown").val().toLowerCase()
                        })
                    }
                },
                // columnDefs: [
                //     // { className: 'text-right', targets: [1] },
                //     { className: 'text-center', targets: [0, 2, 3, 4, 5] },
                // ],
                columns: [
                    {
                        data: 'audio_path',
                        "searchable": false,
                        render: function (data, type, row) {
                            return '<audio controls><source src="' + data + '" type="audio/wav"></audio>'
                        }
                    },
                    {
                        data: "text",
                        searchable: false
                    },
                    {
                        data: "rating",
                        searchable: false,
                    },
                    {
                        data: "device",
                    },
                    {
                        data: 'audio_path',
                        "searchable": false,
                        render: function (data, type, row) {
                            return `<div>
                                <button type="button" class="btn btn-primary">Run model</button>
                                <div class="loader" style='display: none;'></div>
                                <p class='result'></p>
                                </div>
                                `
                        }
                    }
                ]
            });

            $('#device-search, #rating-dropdown').bind('keyup change', function () {
                table.draw();
            });


            $('#feedback-table tbody').on('click', 'button', function () {
                const selectedRow = table.row($(this).parents('tr'));
                const resultElement = selectedRow.node().getElementsByClassName('result')[0]
                const loader = $(selectedRow.node().getElementsByClassName('loader')[0])

                console.log(loader)
                let data = selectedRow.data();
                let audio_path = data['audio_path'];
                let language = data['language'];
                let formData = new FormData();
                formData.append('audio_path', audio_path);
                $.ajax({
                    type: 'POST',
                    url: 'http://localhost:8001/transcribe_gcp?lang=' + language,
                    data: formData,
                    contentType: false,
                    processData: false,
                    crossDomain: true,
                    beforeSend: function () {
                        // Show image container
                        $(loader).show();
                    },
                    success: function (data, textStatus, jqXHR) {
                        console.log(data);
                        try {
                            var final_ = data['transcription']
                            var text = ''
                            console.log(final_[0])
                            console.log(final_[0].length)
                            if (final_.length > 1) {
                                console.log('here 2')
                                text = final_
                                console.log(text)
                                console.log('here')
                                resultElement.innerText = text
                            }
                            else {
                                console.log('in second')
                                resultElement.innerText = final_
                            }
                        }
                        catch (err) { }
                        $(loader).hide();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('Failed: ' + textStatus);
                        $(loader).hide();
                    }

                });

            });
        });
    </script>
</body>

</html>