<!doctype html>
<html>

<head>
    <title>Speech Recognition Models</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="hark.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"
        integrity="sha512-v8ng/uGxkge3d1IJuEo6dJP8JViyvms0cly9pnbfRxT6/31c3dRWxIiwGnMSWwZjHKOuY3EVmijs7k1jz/9bLA=="
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="platform.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <style>
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }

        ::-webkit-input-placeholder {
            /* Chrome/Opera/Safari */
            text-align: center;
        }

        ::-moz-placeholder {
            text-align: center;
        }

        ::-ms-placeholder {
            text-align: center;
        }

        #mic_image:hover {
            border-radius:70%;
            box-shadow: 0 0 14px 8px rgba(33,33,33,.2); 
        } 

        .row {
            padding: 15px;
            margin: 15px;
            border: 1px black solid;
        }

        .rating {
            display: inline-block;
            width: 100%;
            text-align: center;
        }

        #like,
        #dislike {
            display: inline-block;
            cursor: pointer;
            margin: 10px;
        }

        #dislike:hover,
        #like:hover {
            color: #2EBDD1;
            transition: all .2s ease-in-out;
            transform: scale(1.1);
        }

        .active {
            color: #2EBDD1;
        }

        #loader {
            margin-top: 20px;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            -webkit-animation: spin 2s linear infinite;
            /* Safari */
            animation: spin 2s linear infinite;
        }

        /* Safari */
        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light px-4"><a href="https://vakyansh.in"><img
                src="ekstep-logo.svg" style="width:3rem" alt="Ek Step Logo">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span
                class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item p-2 dropdown"><a href="https://inference.vakyansh.in/"
                        class="nav-link text-dark font-weight-bold dropdown-toggle" id="dropdownMenuButton"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Speech Recognition Models </a>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" href="https://codmento.com/kannada">Kannada</a>
                        <a class="dropdown-item" href="https://codmento.com/hindi">Hindi</a>
                        <a class="dropdown-item" href="https://codmento.com/english">English</a>
                        <a class="dropdown-item" href="https://codmento.com/indian-english">Indian-English</a>
                        <a class="dropdown-item" href="https://codmento.com/telugu">Telugu</a>
                        <a class="dropdown-item" href="https://codmento.com/tamil">Tamil</a>
                    </div>
                </li>
                <li class="nav-item p-2"><a href="https://vakyansh.in/about-us"
                        class="nav-link text-dark font-weight-bold">About Us</a>
                </li>
                <li class="nav-item p-2"><a href="https://vakyansh.in/"
                        class="nav-link text-dark font-weight-bold">Vakyansh</a></li>
                <li class="nav-item p-2"><a class="nav-link text-dark font-weight-bold d-none" id="nav-user"><span
                            class="material-icons align-middle mx-1">account_circle</span> <span
                            id="nav-username"></span></a></li>
            </ul>
        </div>
    </nav>
    <center>
        <div class="container">
            <div class="row" style="border: 0px;">
                <div class="col-sm-12">
                    <center>
                        <h4 id="title-text">Speech Recognition Models</h4>
                        <br />
                    </center>
                </div>
            </div>
            <div class="row">
                <!--<div class="col-sm-12">
                    <p>Choose Language:</p>
                    <select class="form-control" id="ddlLanguage" onchange="getval(this);">
                        <option value='en' selected>English</option>
                        <option value='en-IN'>English (IN)</option>
                        <option value='hi'>Hindi</option>
                        <option value='gu'>Gujarati</option>
                        <option value='ta'>Tamil</option>
                        <option value='te'>Telugu</option>
                        <option value='kn'>Kannada</option>
                    </select>
                    <br />
                </div>-->
                <div class="col-sm-12">
                    <br />
                    <div style="min-height:100px;min-width:100px;">
                        <center>
                            <img src="mic.png" id="mic_image" onclick="toggle()" height="100" width="100" alt="MIC" /><br />
                        </center>
                    </div>
                </div>
                <div class="col-sm-12">
                    <br />
                </div>
                <div class="col-sm-12">
                    <textarea id="output" placeholder="Output" rows="6" readonly></textarea>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <h5>Please do provide your rating</h5>
                    <div class="rating">
                        <!-- Thumbs up -->
                        <div id="like" class="grow" data-val="thumbs_up">
                            <i class="fa fa-thumbs-up fa-3x like" aria-hidden="true"></i>
                        </div>
                        <!-- Thumbs down -->
                        <div id="dislike" class="dislike grow" data-val="thumbs_down">
                            <i class="fa fa-thumbs-down fa-3x like" aria-hidden="true"></i>
                        </div>
                    </div>
                    <center>
                        <div id="loader" style='display: none;'></div>
                    </center>
                    <p id="rating-note">(Rating will be enabled only after you speak in the microphone)</p>
                </div>
            </div>
            <div class="row">
                <center>
                    <h4>Vakyansh: The Home of Speech Recognition Essentials for Indian Languages</h4><br />
                    <p>Vakyansh aims to host the key essentials of Automatic Speech Recognition
                        (ASR) technology, focusing on
                        Indian languages. It is a resource that allows people to build applications that leverage speech
                        recognition. <a href="https://vakyansh.in/about-us">Know More</a></p>
                </center>
            </div>
            <!--<div class="row">
                <div class="col-sm-12 col-md-4">
                    <center>
                        <p>Hindi Sample</p>
                        <p>(Harveen Chadha)</p>
                    </center>
                    <audio controls>
                        <source src="hindi2.wav" />
                    </audio>
                </div>
                <div class="col-sm-12 col-md-4">
                    <center>
                        <p>Tamil Sample</p>
                        <p>(Kandan Muthukumar)</p>
                    </center>
                    <audio controls>
                        <source src="tamil.wav" />
                    </audio>
                </div>
                <div class="col-sm-12 col-md-4">
                    <center>
                        <p>Gujarati Sample</p>
                        <p>(Bijal Bharat Kumar Parekh)</p>
                    </center>
                    <audio controls>
                        <source src="gujarati.wav" />
                    </audio>
                </div>
                <div class="col-sm-12 col-md-12">
                    <center>
                        <center>
                            <p>Hindi Sample</p>
                            <p>(Rajat Singhal)</p>
                        </center>
                        <audio controls id="audio_sample_id">
                            <source src="hindi.m4a" id="sample_id" />
                        </audio>
                    </center>
                </div>
            </div>-->
            <!-- <div class="row">
                <div class="col-12">
                    <br/>
                </div>
            </div> -->
        </div>
    </center>
    <footer class="bottom bg-light pt-3 border-top mt-lg-2 w-100">
        <div class="container-fluid">
            <div
                class="d-flex flex-column-reverse flex-lg-row justify-content-lg-around align-items-sm-center align-items-md-center text-center">
                <div class="">
                    <p class="text-muted">&copy; EkStep Foundation, 2020 .</p>
                </div>
                <div class="d-lg-inline-flex justify-content-around mb-2">
                    <div class="p-2"><a href="https://vakyansh.in/about-us">About Us</a></div>
                    <div class="p-2"><a href="https://vakyansh.in/terms-and-conditions">Terms & Conditions</a></div>
                    <div class="p-2"><a href="https://vakyansh.in/terms-and-conditions#privacy-policy">Privacy
                            Policy</a></div>
                </div>
            </div>
        </div>
    </footer>
    <script>
        let start = false, socket;
        let current_lang = 'en', selected_lang = 'en';
        let state = "OFF";
        let speechEvents = null;
        let input, processor, context, globalStream, audioContext;
        let localBuffer = null, isSpeaking = false;
        let timeout_ = null, state_end = false, audioData = [], recordingLength = 0, sampleRate = 44100, socket_disconnect_timeout = null;
        let userId = null, recordedBlob = null, rating = null, device = null, transcription_text = null, transcription_language = null, end_timeout = null;
        const socketIO = io({ autoConnect: false });

        function setRatingAction(flag) {
            let value = flag ? 'auto' : 'none'
            $('#like').css({ 'pointer-events': value })
            $('#dislike').css({ 'pointer-events': value })
            if (flag) {
                $('#rating-note').hide();
            } else {
                $('#rating-note').show();
            }
        }

        function saveToDb() {

            const formData = new FormData();
            formData.append('audio_data', recordedBlob);
            formData.append('rating', rating);
            formData.append('device', device);
            formData.append('text', transcription_text);
            formData.append('language', transcription_language);
            formData.append('user_id', userId);

            $.ajax({
                type: 'POST',
                url: 'api/feedback',
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function () {
                    $("#loader").show();
                },
                success: function (data, textStatus, jqXHR) {
                    console.log(data);
                    $("#loader").hide();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#loader").hide();
                    console.log("failed");
                    alert("Rating update failed, Please try again")
                    setRatingAction(true)
                }

            });
        }

        function fetchCurrentLanguageCode(language) {
            language = language.toLowerCase();
            if (language === "kannada") {
                return "kn";
            } else if (language === "indian-english") {
                return "en-IN";
            } else if (language === "hindi") {
                return "hi";
            } else if (language === "tamil") {
                return "ta";
            } else if (language === "telugu") {
                return "te";
            } else if (language === "gujarati") {
                return "gu";
            } else {
                return "en";
            }
        }
        function toCamelCase(word) {
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
        }
        function connectSocket(startMic, image) {
            socketIO.open();
            socket = socketIO.on('connect', function () {
                start = true;
                console.log("connected");
                startMic(image);
            });
            socket.on('response', function (data, language) {
                if (language === "en-IN") data = data.toLowerCase();
                document.getElementById('output').textContent = data;
                transcription_text = data;
                transcription_language = language;
            });
            socket.on('id', function (id) {
                userId = id;
                console.log(id);
            });
            socket.on('disconnect', function () {
                // if (start)
                //     alert("Website idle for more than 2 minutes. Please refresh to continue.")
                start = false;
                console.log("disconnected");
            })
            socket.on('abort', function () {
                alert("The server is busy at the moment, please try after sometime.");
                $(".container **").attr("disabled", "disabled").off('click');
                document.getElementById('userid').innerHTML = "Server busy. Please refresh the page after some time.";
                // if (socket_disconnect_timeout !== null)
                //     clearTimeout(socket_disconnect_timeout)
                start = false;
            });
        }

        $(document).ready(function () {
            let pathname = window.location.pathname.replace("/", "");
            if (pathname.length != 0) {
                current_lang = fetchCurrentLanguageCode(pathname);
                let titleLanguage = toCamelCase(pathname);
                if (pathname === "indian-english")
                    titleLanguage = "English(IN)";
                document.getElementById("title-text").innerHTML = titleLanguage + " Speech Recognition Model"
            }

            function getDeviceInfo() {
                const os = platform.os;
                let info = os.family + " " + os.version;
                if (platform.product) {
                    info = info + " " + platform.product;
                }
                return info;
            }

            device = getDeviceInfo();
            $('#like, #dislike').on('click', function () {
                event.preventDefault();
                $('.active').removeClass('active');
                $(this).addClass('active');

                rating = $(this).data("val");
                setRatingAction(false)

                saveToDb();
            });
            setRatingAction(false);
            // if (socket_disconnect_timeout !== null)
            //     clearTimeout(socket_disconnect_timeout)
            // socket_disconnect_timeout = timeout(120000, abortSocket)
        });

        function getval(sel) {
            current_lang = sel.value;
            if (state === "ON") {
                stopRecording();
            } else {
                socket.emit("language_reset");
            }
        }
        
        function toggle() {
            // if (!start) {
            //     alert("Not connected! Please Refresh the page and Try again.")
            //     return;
            // }
            if(end_timeout !== null || end_timeout){
                clearTimeout(end_timeout);
                end_timeout = null;
                endSocket();
            }

            let image = document.getElementById("mic_image");
            if (state === "OFF") {
                connectSocket(startRecording, image);
            } else if (state === "ON") {
                if (timeout_ !== null)
                    clearTimeout(timeout_);
                stopRecording();
            }
        }

        function downSampleBuffer(buffer, sampleRate, outSampleRate) {
            if (outSampleRate == sampleRate) {
                return buffer;
            }
            if (outSampleRate > sampleRate) {
                throw "down-sampling rate show be smaller than original sample rate";
            }
            var sampleRateRatio = sampleRate / outSampleRate;
            var newLength = Math.round(buffer.length / sampleRateRatio);
            var result = new Int16Array(newLength);
            var offsetResult = 0;
            var offsetBuffer = 0;
            while (offsetResult < result.length) {
                var nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                var accum = 0, count = 0;
                for (var i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }

                result[offsetResult] = Math.min(1, accum / count) * 0x7FFF;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            return result.buffer;
        }

        function timeout(timeLimit, funcToCall) {
            let timeout = setTimeout(function () {
                funcToCall()
            }, timeLimit);
            return timeout;
        }


        function appendBuffer(buffer1, buffer2) {
            const buffer = new ArrayBuffer(buffer1.byteLength + buffer2.byteLength);
            var tmp = new Uint8Array(buffer);
            tmp.set(new Uint8Array(buffer1), 0);
            tmp.set(new Uint8Array(buffer2), buffer1.byteLength);
            return buffer;
        };

        function startRecording(image) {
            // if (socket_disconnect_timeout !== null)
            //     clearTimeout(socket_disconnect_timeout)
            state = "ON";
            image.src = "stop.png";
            $("#mic_image").animate({zoom: '87%'}, "slow");
            socket.emit("start");
            selected_lang = current_lang;
            audioData = [];
            $('.active').removeClass('active');
            setRatingAction(true);
            timeout_ = timeout(120000, stopRecording);
            let constraints = { audio: true, video: false }
            document.getElementById('output').textContent = "";
            let sendData = false;
            navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                globalStream = stream;
                audioContext = window.AudioContext || window.webkitAudioContext;
                context = new audioContext({
                    latencyHint: 'interactive',
                });

                let options = { audioContext: context };
                speechEvents = hark(stream.clone(), options);

                speechEvents.on('speaking', function () {
                    isSpeaking = true;
                    console.log('speaking');
                });

                speechEvents.on('stopped_speaking', function () {
                    console.log('stopped_speaking');
                    isSpeaking = false;
                });
                let bufferSize = 16384;
                processor = context.createScriptProcessor(bufferSize, 1, 1);
                input = context.createMediaStreamSource(stream);

                processor.connect(context.destination);
                context.resume();
                input.connect(processor);
                let sentOnce = true;
                processor.onaudioprocess = function (e) {
                    audioData.push(new Float32Array(e.inputBuffer.getChannelData(0)));
                    recordingLength += bufferSize;
                    if (state === "ON") {
                        state_end = false;
                        var data_44100 = e.inputBuffer.getChannelData(0);
                        var data_16000 = downSampleBuffer(data_44100, 44100, 16000);
                        if (isSpeaking) {
                            sentOnce = false;

                            if (localBuffer !== undefined && localBuffer !== null) {
                                data_16000 = appendBuffer(localBuffer, data_16000)
                            }
                            console.log("emitted", data_16000);
                            socket.emit('mic_data', data_16000, current_lang, true);
                            localBuffer = null;
                        } else {
                            if (!sentOnce) {
                                sentOnce = true;
                                socket.emit('mic_data', data_16000, current_lang, false);
                                console.log("emitted last");
                            } else {
                                localBuffer = data_16000;
                            }
                        }
                    } else {
                        if (!state_end) {
                            var data_44100 = e.inputBuffer.getChannelData(0);
                            var data_16000 = downSampleBuffer(data_44100, 44100, 16000);
                            state_end = true;
                            socket.emit('mic_data', data_16000, current_lang, false);
                            console.log("emitted last");
                        }
                    }
                };
            }).catch(function (err) {
                console.log(err);
                if (timeout_ !== null)
                    clearTimeout(timeout_)
                stopRecording()
            });
        }

        function abortSocket() {
            socket.disconnect();
        }

        function endSocket(){
            socket.emit("end");
            abortSocket();
        }

        function stopRecording() {
            $("#mic_image").animate({zoom: '100%'}, "slow");
            state = "OFF";
            setTimeout(()=>{
                let image = document.getElementById("mic_image");
                image.src = "mic.png";
                // socket_disconnect_timeout = timeout(120000, abortSocket)
                endProcess();
            },1000);
        }

        function endProcess() {
            stopIt();
            speechEvents.stop();
            let finalBuffer = flattenArray(audioData, recordingLength);
            let blob = generateWavBlob(finalBuffer);
            if (blob == null) {
                console.log("no blob generated");
                return;
            }
            recordedBlob = blob;
            
            end_timeout = setTimeout(()=>{
                endSocket();
                end_timeout = null;
            }, 4000);
            // let url = window.URL.createObjectURL(blob);
            // document.getElementById("sample_id").src = url;
            // document.getElementById("audio_sample_id").load();
        }

        function stopIt() {
            try {
                let track = globalStream.getTracks()[0];
                if (track)
                    track.stop();
            } catch (err) {
                console.log(err);
            }

            try {
                input.disconnect(processor);
            } catch (err) {
                console.log(err);
            }
            try {
                processor.disconnect(context.destination);
            } catch (err) {
                console.log(err);
            }
            context.close().then(function () {
                input = null;
                processor = null;
                context = null;
                audioContext = null;
            }).catch(err => {
                input = null;
                processor = null;
                context = null;
                audioContext = null;
                console.log(err);
            });
        }

        function flattenArray(channelBuffer, recordingLength) {
            var result = new Float32Array(recordingLength);
            var offset = 0;
            for (var i = 0; i < channelBuffer.length; i++) {
                var buffer = channelBuffer[i];
                result.set(buffer, offset);
                offset += buffer.length;
            }
            return result;
        }

        function writeUTFBytes(view, offset, string) {
            for (var i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function generateWavBlob(finalBuffer) {
            let buffer = new ArrayBuffer(44 + finalBuffer.length * 2);
            let view = new DataView(buffer);

            // RIFF chunk descriptor
            writeUTFBytes(view, 0, 'RIFF');
            view.setUint32(4, 44 + finalBuffer.length * 2, true);
            writeUTFBytes(view, 8, 'WAVE');
            // FMT sub-chunk
            writeUTFBytes(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // chunkSize
            view.setUint16(20, 1, true); // wFormatTag
            view.setUint16(22, 1, true); // wChannels:mono(1 channel) / stereo (2 channels)
            view.setUint32(24, sampleRate, true); // dwSamplesPerSec
            view.setUint32(28, sampleRate * 2, true); // dwAvgBytesPerSec
            view.setUint16(32, 4, true); // wBlockAlign
            view.setUint16(34, 16, true); // wBitsPerSample
            // data sub-chunk
            writeUTFBytes(view, 36, 'data');
            view.setUint32(40, finalBuffer.length * 2, true);

            // write the PCM samples
            let index = 44;
            let volume = 1;
            for (var i = 0; i < finalBuffer.length; i++) {
                view.setInt16(index, finalBuffer[i] * (0x7FFF * volume), true);
                index += 2;
            }

            // our final blob
            let blob = new Blob([view], { type: 'audio/wav' });
            return blob;
        }
    </script>
</body>

</html>