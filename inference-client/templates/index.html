<!doctype html>
<html>

<head>
    <title>Wav2Vec Inference</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.WebRTC-Experiment.com/RecordRTC.js"></script>
    <script src="static/hark.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"
        integrity="sha512-v8ng/uGxkge3d1IJuEo6dJP8JViyvms0cly9pnbfRxT6/31c3dRWxIiwGnMSWwZjHKOuY3EVmijs7k1jz/9bLA=="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io-stream/0.9.1/socket.io-stream.min.js"
        integrity="sha512-LTN7WQKvmCiOWbwxE4XRu3NCRqLzkFo28vBDHVhAyKjhmorNGjtvFxQgbvAttO31Ij6An4AIXU4GVaYOC0eNpQ=="
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <style>
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }

        ::-webkit-input-placeholder {
            /* Chrome/Opera/Safari */
            text-align: center;
        }
        ::-moz-placeholder {
            text-align: center;
        }
        ::-ms-placeholder {
            text-align: center;
        }

        .btn-bs-file {
            position: relative;
            font-size: 16px;
            width: 200px;
        }

        .btn-bs-file input[type="file"] {
            position: absolute;
            top: -9999999;
            filter: alpha(opacity=0);
            opacity: 0;
            width: 0;
            height: 0;
            outline: none;
            cursor: inherit;
        }

        .row {
            padding: 15px;
            margin: 15px;
            border: 1px black solid;
        }

        .btn {
            width: 200px;
        }
    </style>
</head>

<body>
    <center>
        <div class="container">
            <div class="row" style="border: 0px;">
		<div class="col-sm-12">
		<center>
                    <h4>Wav2Vec Inference Service</h4>
			<br/>
                    <p>(No Language model present)</p>
                </center>
		</div>
		<div class="col-sm-12">
                    <div class="row">
                        <div class="col-sm-12">
                            <p>Choose Language:</p>
                            <select class="form-control" id="ddlLanguage" onchange="getval(this);">
                                <option value='en' selected >English</option>
                                <option value='hi'>Hindi</option>
                                <option value='gu'>Gujarati</option>
                                <option value='ta'>Tamil</option>
                                <option value='te'>Telugu</option>
                              </select>
                            <br />
                        </div>
                        <div class="col-sm-12">
                            <img src="static/mic.webp" id="mic_image" onclick="toggle()" height="100" width="100" alt="mic"/><br />
                        </div>
                        <div class="col-sm-12">
                            <br />
                        </div>
                        <div class="col-sm-12">
                            <audio controls id="audio">
                                <source src="" id="out_audio_source">
                            </audio>
                        </div>
                        <div class="col-sm-12">
                            <textarea id="output" placeholder="Output" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </center>
    <script>
        var start = false, socket;
        var current_lang = 'en', selected_lang = 'en';
        var state = "OFF";
        let input, processor, context, globalStream, AudioContext;

        $(document).ready(function () {
            const socketIO = io();
            socket = socketIO.on('connect', function () {
                start = true;
            });
            socket.on('response', function (data, language) {
                document.getElementById('output').textContent = data;
            });
        });


        function toggle() {
            if (!start) {
                alert("Try again")
                return;
            }
            let image = document.getElementById("mic_image");
            if (state === "OFF") {
                state = "ON";
                image.src = "static/stop.webp";
                socket.emit("start");
                selected_lang = current_lang;
                startRecording(image);
            } else if (state === "ON") {
                stopRecording()
            }
        }

        function downSampleBuffer(buffer, sampleRate, outSampleRate) {
            if (outSampleRate == sampleRate) {
                return buffer;
            }
            if (outSampleRate > sampleRate) {
                throw "down-sampling rate show be smaller than original sample rate";
            }
            var sampleRateRatio = sampleRate / outSampleRate;
            var newLength = Math.round(buffer.length / sampleRateRatio);
            var result = new Int16Array(newLength);
            var offsetResult = 0;
            var offsetBuffer = 0;
            while (offsetResult < result.length) {
                var nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                var accum = 0, count = 0;
                for (var i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }

                result[offsetResult] = Math.min(1, accum / count) * 0x7FFF;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            return result.buffer;
        }
        let isSpeaking = false;
        function startRecording(image) {
            let constraints = { audio: true, video: false }
            document.getElementById('output').textContent = "";
            navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {

                globalStream = stream;
                AudioContext = window.AudioContext || window.webkitAudioContext;
                context = new AudioContext({
                  latencyHint: 'interactive',
                });

                var options = {audioContext: context};
                var speechEvents = hark(stream, options);

                speechEvents.on('speaking', function() {
                  isSpeaking = true;
                  console.log('speaking');
                });

                speechEvents.on('stopped_speaking', function() {
                  console.log('stopped_speaking');
                  isSpeaking = false;
                });

                processor = context.createScriptProcessor(16384, 1, 1);
                input = context.createMediaStreamSource(stream);

                processor.connect(context.destination);
                context.resume();
                input.connect(processor);
                let sentOnce=false;
                processor.onaudioprocess = function (e) {
                  var data_44100 = e.inputBuffer.getChannelData(0);
                  var data_16000 = downSampleBuffer(data_44100, 44100, 16000);
                  let date = getDate();
                  if(isSpeaking){
                    sentOnce = false;
                    console.log("emitted", date);
                    socket.emit('mic_data', data_16000, current_lang,true);
                  } else {
                    if(!sentOnce){
                        sentOnce= true;
                        socket.emit('mic_data', data_16000, current_lang,false);
                    }
                  }
                };
            }).catch(function (err) {
                image.src = "static/mic.webp";
                state = "OFF";
                console.log(err);
            });
        }

        function stopIt(){
            let track = globalStream.getTracks()[0];
            track.stop();

            input.disconnect(processor);
            processor.disconnect(context.destination);
            context.close().then(function () {
                input = null;
                processor = null;
                context = null;
                AudioContext = null;
            });
        }

        function stopRecording(){
            stopIt();
            let image = document.getElementById("mic_image");
            state = "OFF";
            image.src = "static/mic.webp";
            socket.emit("end");
        }

        function getval(sel){
            current_lang = sel.value;
            if(state === "ON") {
              stopRecording();
            }
        }


        function addZero(x, n) {
          while (x.toString().length < n) {
            x = "0" + x;
          }
          return x;
        }

        function getDate() {
          var d = new Date();
          var x = document.getElementById("demo");
          var h = addZero(d.getHours(), 2);
          var m = addZero(d.getMinutes(), 2);
          var s = addZero(d.getSeconds(), 2);
          var ms = addZero(d.getMilliseconds(), 3);
          return h + ":" + m + ":" + s + ":" + ms;
        }
    </script>
</body>

</html>
